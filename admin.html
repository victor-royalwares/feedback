<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<style>
body{font-family:sans-serif;background:#1a0a3e;color:#fff;margin:0;padding:0;}
main{max-width:600px;margin:2rem auto;padding:2rem;background:rgba(255,255,255,0.05);border-radius:15px;}
h2{margin-bottom:1rem;color:#d8b4fe;}
#metrics{margin-bottom:1rem;}
#metrics span{margin-right:1rem;background:rgba(124,58,237,0.3);padding:0.3rem 0.6rem;border-radius:12px;}
.chat{height:400px;overflow-y:auto;background:rgba(255,255,255,0.05);padding:1rem;border-radius:15px;display:flex;flex-direction:column;gap:0.5rem;}
.user-msg{background:rgba(124,58,237,0.3);align-self:flex-start;padding:0.6rem 1rem;border-radius:25px;}
.admin-msg{background:rgba(255,255,255,0.15);align-self:flex-end;padding:0.6rem 1rem;border-radius:25px;color:#d8b4fe;}
.bot-msg{background:rgba(255,255,255,0.1);align-self:flex-end;padding:0.6rem 1rem;border-radius:25px;color:#c4b5fd;font-style:italic;}
#reply{width:100%;padding:0.8rem;margin-top:0.5rem;border-radius:12px;border:1px solid #7c3aed;background:rgba(255,255,255,0.1);color:#fff;}
button{width:100%;padding:0.8rem;margin-top:0.5rem;border-radius:12px;border:none;background:#7c3aed;color:#fff;cursor:pointer;}
button:hover{background:#a78bfa;}
</style>
</head>
<body>
<main>
<h2>Admin Dashboard</h2>
<div id="metrics">
  <span id="csat-badge">CSAT: 0</span>
  <span id="nps-badge">NPS: 0</span>
  <span id="ces-badge">CES: 0</span>
</div>
<div class="chat" id="chat"></div>
<input type="text" id="reply" placeholder="Type your reply...">
<button id="send-btn">Send Reply</button>
</main>

<script>
const API="http://127.0.0.1:5000";
const chatDiv=document.getElementById("chat");
const replyInput=document.getElementById("reply");
const sendBtn=document.getElementById("send-btn");
let messages=[];
let selectedMsgId=null;

// Add chat message
function addMessage(msg){
  const div=document.createElement("div");
  if(msg.bot_replied) div.className="bot-msg";
  else if(msg.reply && !msg.bot_replied && msg.user_id===msg.user_id) div.className="admin-msg";
  else div.className="user-msg";

  let text=msg.text;
  if(msg.ai) text+=" ["+msg.ai.emotion+"]";
  div.innerText=text;
  div.onclick=()=>{selectedMsgId=msg.id; replyInput.focus();}
  chatDiv.appendChild(div);
  chatDiv.scrollTop=chatDiv.scrollHeight;
}

// Update metrics
function updateMetrics(metrics){
  document.getElementById("csat-badge").innerText="CSAT: "+metrics.csat;
  document.getElementById("nps-badge").innerText="NPS: "+metrics.nps;
  document.getElementById("ces-badge").innerText="CES: "+metrics.ces;
}

// SSE
const evtSource=new EventSource(`${API}/admin_stream`);
evtSource.onmessage=function(event){
  const data=JSON.parse(event.data);
  messages=data.messages;
  chatDiv.innerHTML="";
  messages.forEach(addMessage);
  updateMetrics(data.metrics);
}

// Send reply
sendBtn.onclick=async ()=>{
  const text=replyInput.value.trim();
  if(!text || selectedMsgId===null) return;
  await fetch(`${API}/admin_reply`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({msg_id:selectedMsgId,text})
  });
  replyInput.value="";
  selectedMsgId=null;
}
</script>
</body>
</html>
